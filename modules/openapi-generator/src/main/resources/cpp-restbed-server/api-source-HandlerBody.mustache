const auto request = session->get_request();
{{#hasBodyParam}}
// body params or form params here from the body content string
std::string bodyContent = extractBodyContent(session);
{{#bodyParams}}
{{#isModel}}
auto {{paramName}} = extractJsonModelBodyParam<{{{baseType}}}>(bodyContent);
{{/isModel}}
{{#isArray}}
auto {{paramName}} = extractJsonArrayBodyParam<{{{baseType}}}>(bodyContent);
{{/isArray}}
{{#isMap}}
{{{dataType}}} {{paramName}}; // TODO
{{/isMap}}
{{^isModel}}
{{^isArray}}
{{^isMap}}
auto {{paramName}} = boost::lexical_cast<{{{dataType}}}>(bodyContent);
{{/isMap}}
{{/isArray}}
{{/isModel}}
{{/bodyParams}}
{{/hasBodyParam}}
{{#hasFormParams}}
{{#formParams}}
{{#isContainer}}
const std::string {{{paramName}}}_raw = extractFormParamsFromBody("{{paramName}}", extractBodyContent(session));
{{{dataType}}} {{{paramName}}};
boost::split({{{paramName}}}, {{{paramName}}}_raw, boost::is_any_of(","));
{{/isContainer}}
{{^isContainer}}
auto {{paramName}} = boost::lexical_cast<{{{dataType}}}>(extractFormParamsFromBody("{{paramName}}", extractBodyContent(session)));
{{/isContainer}}
{{/formParams}}
{{/hasFormParams}}
{{#hasPathParams}}
// Getting the path params
{{#pathParams}}
{{#isPrimitiveType}}
const {{{dataType}}} {{{paramName}}} = request->get_path_parameter("{{{baseName}}}", {{{defaultValue}}});
{{/isPrimitiveType}}
{{/pathParams}}
{{/hasPathParams}}
{{#hasQueryParams}}
// Getting the query params
{{#queryParams}}
{{#isPrimitiveType}}
const {{{dataType}}} {{{paramName}}} = request->get_query_parameter("{{{paramName}}}", {{{defaultValue}}});
{{/isPrimitiveType}}
{{^isPrimitiveType}}
{{#isArray}}
const std::string {{{paramName}}}_raw = request->get_query_parameter("{{{paramName}}}");
{{{dataType}}} {{{paramName}}};
boost::split({{{paramName}}}, {{{paramName}}}_raw, boost::is_any_of(","));
{{/isArray}}
{{#isMap}}
std::stringstream {{{paramName}}}_raw(request->get_query_parameter("{{{paramName}}}"));
boost::property_tree::ptree {{{paramName}}}_pt;
boost::property_tree::json_parser::read_json({{{paramName}}}_raw,{{{paramName}}}_pt);
{{{dataType}}} {{{paramName}}} = {{{defaultValue}}};
for (auto& item: {{{paramName}}}_pt) {
    {{{paramName}}}->emplace(item.first, item.second.get_value<{{{baseType}}}>());
}
{{/isMap}}
{{/isPrimitiveType}}
{{/queryParams}}
{{/hasQueryParams}}
{{#hasHeaderParams}}
// Getting the headers
{{#headerParams}}
{{#isPrimitiveType}}
const {{{dataType}}} {{{paramName}}} = request->get_header("{{{baseName}}}", {{{defaultValue}}});
{{/isPrimitiveType}}
{{#isContainer}}
const std::string {{{paramName}}}_raw = request->get_header("{{{paramName}}}");
{{{dataType}}} {{{paramName}}};
boost::split({{{paramName}}}, {{{paramName}}}_raw, boost::is_any_of(","));
{{/isContainer}}
{{/headerParams}}
{{/hasHeaderParams}}

int status_code = 500;
{{#returnType}}
{{{.}}} resultObject = {{{defaultResponse}}};
{{/returnType}}
std::string result = "";

try {
{{#returnType}}
    std::tie(status_code, resultObject) =
{{/returnType}}
{{^returnType}}
    status_code =
{{/returnType}}
        handler_{{httpMethod}}({{#allParams}}{{paramName}}{{^-last}}, {{/-last}}{{/allParams}});
}
catch(const {{classname}}Exception& e) {
    std::tie(status_code, result) = handle{{classname}}Exception(e);
}
catch(const std::exception& e) {
    std::tie(status_code, result) = handleStdException(e);
}
catch(...) {
    std::tie(status_code, result) = handleUnspecifiedException();
}

{{#responses}}
if (status_code == {{code}}) {
{{#returnType}}
{{#isModel}}
{{#isString}}
    result = resultObject;
{{/isString}}
{{^isString}}
{{^isMap}}
    result = resultObject->toJsonString();
{{/isMap}}
{{/isString}}
{{/isModel}}
{{#isMap}}
    result = convertMapResponse(resultObject);
{{/isMap}}
{{/returnType}}
{{#headers}}
    // Description: {{{description}}}
    setResponseHeader(session, "{{baseName}}");
{{/headers}}

{{#primitiveType}}
    const constexpr auto contentType = "text/plain";
{{/primitiveType}}
{{^primitiveType}}
    const constexpr auto contentType = "application/json";
{{/primitiveType}}
    returnResponse(session, {{code}}, result.empty() ? "{{message}}" : result, contentType);
    return;
}
{{/responses}}
defaultSessionClose(session, status_code, result);
