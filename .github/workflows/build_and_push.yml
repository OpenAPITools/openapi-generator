name: Build and Push Open API Generator Image
on:
  pull_request:
  push:
    branches:
      - 'master'

jobs:
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    env:
      ACR_HOST: ${{ secrets.ACR_HOST }}
      ACR_PUSH_USER: ${{ secrets.ACR_PUSH_USER}}
      ACR_PUSH_PASSWORD: ${{ secrets.ACR_PUSH_PASSWORD }}
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: '0'
          ssh-key: ${{ secrets.SSH_KEY_SUBMODULES }}
          submodules: recursive
      - name: Build Image
        run: |
          ./run-in-docker-ci.sh mvn package
          cp docker-entrypoint.sh ./modules/openapi-generator-cli;
          cd modules/openapi-generator-cli
          docker build --progress plain -t open-api-generator .
      - name: Push Image
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          docker login ${ACR_HOST} -u ${ACR_PUSH_USER} -p ${ACR_PUSH_PASSWORD}

          docker tag open-api-generator ${ACR_HOST}/padoa-tools/open-api-generator:$BRANCH_NAME

          docker push ${ACR_HOST}/padoa-tools/open-api-generator:$BRANCH_NAME